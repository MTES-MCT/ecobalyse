name: Score History

on:
  push:
    branches:
      - '*'
  workflow_dispatch:

jobs:
  score_history:
    runs-on: ubuntu-latest
    # Run the job only on push to master, staging or if the commit contains "[score_history]"
    if: ${{ github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/staging' || contains(github.event.head_commit.message, '[score_history]') }}
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
          persist-credentials: true
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: "3.10"
      - name: Install dependencies
        run: pip install numpy pandas requests python-dotenv GitPython sqlalchemy psycopg2
      - name: Score History
        env:
          GITHUB_REF_NAME: ${{ github.ref_name }}
          LAST_COMMIT_HASH: ${{ github.sha }}
          SCALINGO_POSTGRESQL_SCORE_URL: ${{ secrets.SCALINGO_POSTGRESQL_SCORE_URL }}
          DJANGO_BYPASS_AUTH: True
        run: |
          npm run server:start &
          npm run start:backend &
          python data/common/score_history/score_history.py http://localhost:8001 $GITHUB_REF_NAME $LAST_COMMIT_HASH $SCALINGO_POSTGRESQL_SCORE_URL
