#!/usr/bin/env node

/**
 * This script generates JSON Db fixtures so tests can perform assertions
 * against actual JSON data without having to rely on Http requests, which
 * is impossible in an Elm test environment.
 */
const fs = require("fs");

console.log(`Building database for the ${process.env.NODE_ENV} envâ€¦`);

let foodProcesses, textileProcesses;

if (process.env.NODE_ENV === "test") {
  if (!process.env.ECOBALYSE_DATA_DIR) {
    console.error(
      `
ðŸš¨ ERROR: For the tests to work properly, you need to specify ECOBALYSE_DATA_DIR env variable.
   It needs to point to a directory with the detailed versions of the processes files. Please, edit your .env file accordingly.",
   -> Exiting the test process.
`,
    );
    process.exit(1);
  }
  foodProcesses = `${process.env.ECOBALYSE_DATA_DIR}/data/food/processes_impacts.json`;
  textileProcesses = `${process.env.ECOBALYSE_DATA_DIR}/data/textile/processes_impacts.json`;
} else {
  foodProcesses = "public/data/food/processes.json";
  textileProcesses = "public/data/textile/processes.json";
}

function getJson(path) {
  const raw = JSON.parse(fs.readFileSync(path).toString());
  // Adapts a standard JSON string to what is expected to be the format
  // used in Elm's template strings (`"""{}"""`).
  return JSON.stringify(raw).replaceAll("\\", "\\\\");
}

const targetDbFile = "src/Static/Json.elm";
const elmTemplate = fs.readFileSync(`${targetDbFile}-template`).toString();
const elmWithFixtures = elmTemplate
  // Transverse JSON data
  .replace("%countriesJson%", getJson("public/data/countries.json"))
  .replace("%impactsJson%", getJson("public/data/impacts.json"))
  .replace("%transportsJson%", getJson("public/data/transports.json"))
  // Food JSON data
  .replace("%foodIngredientsJson%", getJson("public/data/food/ingredients.json"))
  .replace("%foodProcessesJson%", getJson(foodProcesses))
  .replace("%foodProductExamplesJson%", getJson("public/data/food/examples.json"))
  // Textile JSON data
  .replace("%textileMaterialsJson%", getJson("public/data/textile/materials.json"))
  .replace("%textileProcessesJson%", getJson(textileProcesses))
  .replace("%textileProductExamplesJson%", getJson("public/data/textile/examples.json"))
  .replace("%textileProductsJson%", getJson("public/data/textile/products.json"));

const header =
  "---- THIS FILE WAS GENERATED FROM THE FILE `Json.elm-template` BY THE `/bin/build-db` SCRIPT";

try {
  fs.writeFileSync(targetDbFile, `${header}\n\n${elmWithFixtures}`);
  const fileSizeInKB = Math.ceil(fs.statSync(targetDbFile).size / 1024);
  console.log(`Successfully generated Elm static database at ${targetDbFile} (${fileSizeInKB}Â KB)`);
} catch (err) {
  throw new Error(`Unable to generate Elm static database: ${err}`);
}
