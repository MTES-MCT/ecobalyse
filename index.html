<!DOCTYPE HTML>
<html lang="fr" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>README - Ecobalyse - Documentation technique</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html" class="active"><strong aria-hidden="true">1.</strong> README</a></li><li class="chapter-item expanded "><a href="gestion-des-tests.html"><strong aria-hidden="true">2.</strong> Gestion des tests</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Ecobalyse - Documentation technique</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="ecobalyse"><a class="header" href="#ecobalyse">Ecobalyse <img src="https://github.com/MTES-MCT/ecobalyse/actions/workflows/node.js.yml/badge.svg" alt="Build status" /></a></h1>
<blockquote>
<p>Accélerer la mise en place de l'affichage environnemental</p>
</blockquote>
<p>L'application est accessible <a href="https://ecobalyse.beta.gouv.fr/">à cette adresse</a>.</p>
<blockquote>
<p>Note: le projet Ecobalyse s'appellait initialement <strong>Wikicarbone</strong>.</p>
</blockquote>
<h2 id="socle-technique-et-prérequis"><a class="header" href="#socle-technique-et-prérequis">Socle technique et prérequis</a></h2>
<p>Le frontend de cette application est écrite en <a href="https://elm-lang.org/">Elm</a>. Vous devez disposer d'un environnement <a href="https://nodejs.org/fr/">NodeJS</a> 14+ et <code>npm</code>. Pour le backend vous devez disposer d'un environnement <a href="https://www.python.org/">python</a> &gt;=3.11, <a href="https://pipenv.pypa.io/">pipenv</a> et <a href="https://www.gnu.org/software/gettext/">gettext</a> sur votre machine.</p>
<h2 id="installation"><a class="header" href="#installation">Installation</a></h2>
<h3 id="frontend"><a class="header" href="#frontend">Frontend</a></h3>
<pre><code class="language-shell">$ npm install
</code></pre>
<h3 id="backend"><a class="header" href="#backend">Backend</a></h3>
<pre><code class="language-shell">$ pipenv install
</code></pre>
<p>Assurez-vous d'avoir un PostgreSQL &gt;=16 qui tourne localement si vous souhaitez vous rapprocher de l'environnement de production. À défaut, <code>sqlite</code> sera utilisé.</p>
<p>Pour créer et lancer un PostgreSQL sur le port 5433 en local en utilisant <code>docker</code> :</p>
<pre><code class="language-shell"># Création du volume pour persister les données
$ docker volume create ecobalyse_postgres_data

# Lancement du docker postgres 16
$ docker run --name ecobalyse-postgres -e POSTGRES_PASSWORD=password -d -p 5433:5432 -v ecobalyse_postgres_data:/var/lib/postgresql/data postgres:16

# Création de la base de données ecobalyse_dev
$ docker exec -it ecobalyse-postgres createdb -U postgres ecobalyse_dev
</code></pre>
<p>Vous devriez pouvoir y accéder via votre <code>psql</code> local avec la commande suivante :</p>
<pre><code class="language-shell">$ psql -U postgres -p 5433 -h localhost ecobalyse_dev
</code></pre>
<h2 id="configuration"><a class="header" href="#configuration">Configuration</a></h2>
<p>Les variables d'environnement suivantes doivent être définies :</p>
<ul>
<li><code>BACKEND_ADMINS</code> : la liste des emails des administrateurs initiaux, séparés par une virgule</li>
<li><code>DEFAULT_FROM_EMAIL</code> : l'email utilisé comme origine pour les mails liés à l'authentification (par défaut ecobalyse@beta.gouv.fr)</li>
<li><code>DJANGO_DEBUG</code>: la valeur du mode DEBUG de Django (par défaut <code>True</code>)</li>
<li><code>DJANGO_SECRET_KEY</code> : la <a href="https://docs.djangoproject.com/en/5.0/ref/settings/#std-setting-SECRET_KEY">clé secrète de Django</a></li>
<li><code>ECOBALYSE_DATA_DIR</code>: l'emplacement du dépôt de données détaillées sur le système de fichier. Note: à terme, cette valeur deviendra optionnelle pour autoriser un fonctionnement en mode restreint.</li>
<li><code>EMAIL_HOST</code> : le host SMTP pour envoyer les mail liés à l'authentification</li>
<li><code>EMAIL_HOST_USER</code>: l'utilisateur du compte SMTP</li>
<li><code>EMAIL_HOST_PASSWORD</code> : le mot de passe du compte SMTP pour envoyer les mail liés à l'authentification</li>
<li><code>MATOMO_HOST</code>: le domaine de l'instance Matomo permettant le suivi d'audience du produit (typiquement <code>stats.beta.gouv.fr</code>).</li>
<li><code>MATOMO_SITE_ID</code>: l'identifiant du site Ecobalyse sur l'instance Matomo permettant le suivi d'audience du produit.</li>
<li><code>MATOMO_TOKEN</code>: le token Matomo permettant le suivi d'audience du produit.</li>
<li><code>NODE_ENV</code>: l'environnement d'exécution nodejs (par défaut, <code>production</code>)</li>
<li><code>SCALINGO_POSTGRESQL_URL</code> : l'uri pour accéder à Postgresl (définie automatiquement par Scalingo). Si non défini sqlite3 est utilisé.</li>
<li><code>SENTRY_DSN</code>: le DSN <a href="https://sentry.io">Sentry</a> à utiliser pour les rapports d'erreur.</li>
</ul>
<p>En développement, copiez le fichier <code>.env.sample</code>, renommez-le <code>.env</code>, et mettez à jour les valeurs qu'il contient ; le serveur de développement node chargera les variables en conséquences.</p>
<p>Pour utiliser le PostgreSQL lancé avec docker, configurez la variable <code>SCALINGO_POSTGRESQL_URL</code> comme ceci :</p>
<pre><code class="language-shall">$ SCALINGO_POSTGRESQL_URL=postgres://postgres:password@localhost:5433/ecobalyse_dev
</code></pre>
<h2 id="chargement-des-données-par-défaut"><a class="header" href="#chargement-des-données-par-défaut">Chargement des données par défaut</a></h2>
<p>Pour initialiser la base de données (attention, toutes les données présentes, si il y en a, seront supprimées) :</p>
<pre><code class="language-shell">$ pipenv run ./backend/update.sh
</code></pre>
<h2 id="développement"><a class="header" href="#développement">Développement</a></h2>
<h3 id="environnement-de-développement-local"><a class="header" href="#environnement-de-développement-local">Environnement de développement local</a></h3>
<p>Le serveur local de développement se lance au moyen des deux commandes suivantes :</p>
<pre><code class="language-shell">$ npm start
</code></pre>
<p>Trois instances de développement sont alors accessibles :</p>
<ul>
<li><a href="http://localhost:8002/">localhost:8002</a> sert le backend django utilisé pour l'authentification, et sert aussi les fichiers statiques de elm. Sert aussi <a href="http://localhost:8002/admin/">l'admin django</a></li>
<li><a href="http://localhost:8001/">localhost:8001</a> sert l'API ;</li>
<li><a href="http://localhost:1234/">localhost:1234</a> est l'URL à utiliser en développement pour tester l'intégration des trois composants (le front, l'API et le Django) car un proxy Parcel renvoie certaines requêtes vers le port 8001 ou 8002 (voir <code>.proxyrc</code>). Le frontend est servi en mode <em>hot-reload</em>, pour recharger! l'interface Web à chaque modification du code frontend.</li>
</ul>
<blockquote>
<p>ℹ️ Pour accéder à l'admin django, utilisez l'email <code>foo@bar.baz</code>. Le lien d'activation pour se connecter automatiquement à l'admin sera affiché dans votre terminal.</p>
</blockquote>
<h3 id="hooks-git-avec-pre-commit-et-formatage-de-code-avec-prettier-et-ruff"><a class="header" href="#hooks-git-avec-pre-commit-et-formatage-de-code-avec-prettier-et-ruff">Hooks Git avec pre-commit et Formatage de Code avec Prettier et Ruff</a></h3>
<p>Ce projet utilise https://pre-commit.com/ pour gérer les hooks Git ainsi que Prettier et Ruff pour le formatage automatique du code.
Le build sur le CI échouera si les fichiers python, javascript et json ne sont pas proprement formattés.</p>
<h4 id="vérification-automatique-avant-chaque-commit"><a class="header" href="#vérification-automatique-avant-chaque-commit">Vérification Automatique avant chaque Commit</a></h4>
<p>Pour installer les hooks pre-commit, exécutez la commande suivante :</p>
<pre><code class="language-shell">$ pipenv run pre-commit install
</code></pre>
<p>Un hook de pre-commit sera alors configuré pour vérifier que le code est bien formaté avant de permettre le commit. Le hook corrigera les erreurs dans la mesure du possible. Il vous suffira alors d'ajouter les modifications à votre staging, git puis à refaire votre commit.</p>
<p>Il est possible de lancer la vérification du formatage à la main grâce à la commande suivante :</p>
<pre><code class="language-shell">$ npm run lint:all
</code></pre>
<p>Si vous voulez lancer la correction automatique de tous les problèmes détectés, lancez :</p>
<pre><code class="language-shell">$ npm run fix:all
</code></pre>
<p>Si vous ne souhaitez pas que la vérification se fasse de manière automatique, vous pouvez désinstaller pre-commit et les hooks associés :</p>
<pre><code class="language-shell">$ pipenv run pre-commit uninstall
</code></pre>
<h2 id="compilation"><a class="header" href="#compilation">Compilation</a></h2>
<p>Pour compiler la partie client de l'application :</p>
<pre><code class="language-shell">$ npm run build
</code></pre>
<p>Les fichiers sont alors générés dans le répertoire <code>build</code> à la racine du projet, qui peut être servi de façon statique.</p>
<h2 id="déploiement"><a class="header" href="#déploiement">Déploiement</a></h2>
<p>L'application est déployée automatiquement sur la plateforme <a href="https://scalingo.com/">Scalingo</a> à chaque mise à jour de la branche <code>master</code> sur <a href="https://github.com/MTES-MCT/ecobalyse/tree/master">le dépôt</a>.</p>
<p>Chaque <em>Pull Request</em> effectuée sur le dépôt est également automatiquement déployée sur une instance de revue spécifique, par exemple <code>https://ecobalyse-pr44.osc-fr1.scalingo.io/</code> pour la pull request #44. <strong>Ces instances de recette restent actives 72 heures, puis sont automatiquement décommisionnées passé ce délai ou si la pull request correspondante est mergée.</strong></p>
<h3 id="ajout-dune-variable-denvironnement"><a class="header" href="#ajout-dune-variable-denvironnement">Ajout d'une variable d'environnement</a></h3>
<p>Pour ajouter une variable d'environnement sur une application, il est recommandé d'utiliser le CLI scalingo qui permet d'ajouter des valeurs qui contiennent plusieurs lignes (à la différence de l'interface graphique qui ne le permet pas) :</p>
<pre><code class="language-shell">$ scalingo --app ecobalyse env-set "MY_VAR=$(cat fichier.key)"
</code></pre>
<h3 id="lien-avec-ecobalyse_private"><a class="header" href="#lien-avec-ecobalyse_private">Lien avec ecobalyse_private</a></h3>
<p>Lorsqu'un déploiement est effectué sur une branche, les données utilisées du dépôt <code>ecobalyse_private</code> sont celles de la branche <code>main</code>. Cependant, si la description de la Pull Request sur le repo <code>ecobalyse</code> mentionne <code>ecobalyse_data: branch-a</code> avec branch-a étant une branche du dépôt <code>ecobalyse_private</code>, alors la PR utilisera les données de la branche <code>branch-a</code> du dépôt <code>ecobalyse_private</code>.</p>
<h4 id="points-dattention"><a class="header" href="#points-dattention">Points d'attention</a></h4>
<p>Lors du merge d'une PR, il est important de merger d'abord la PR correspondante sur ecobalyse_private, puis celle sur ecobalyse.</p>
<h1 id="serveur-de-production"><a class="header" href="#serveur-de-production">Serveur de production</a></h1>
<h2 id="variables-denvironnement"><a class="header" href="#variables-denvironnement">Variables d'environnement</a></h2>
<p>Les variables d'environnement doivent être positionnées via l'interface de <a href="https://dashboard.scalingo.com/apps/osc-fr1/ecobalyse/environment">configuration Scalingo</a> (voir la section <a href="#configuration">Configuration</a>).</p>
<h2 id="lancement-du-serveur"><a class="header" href="#lancement-du-serveur">Lancement du serveur</a></h2>
<p>Pour lancer le serveur applicatif complet (frontend + backend), par exemple depuis un environnement de production, la démarche est la suivante :</p>
<pre><code class="language-shell">$ npm run build
$ npm run server:start
</code></pre>
<p>L'application est alors servie sur le port 1234.</p>
<h1 id="ecobalyse-data"><a class="header" href="#ecobalyse-data">Ecobalyse data</a></h1>
<p>Ce dépôt contient aussi les scripts (principalement python) utilisés pour
importer et exporter les données du projet <a href="https://github.com/MTES-MCT/ecobalyse">Ecobalyse</a>.</p>
<p>Ces scripts se trouvent dans <code>data/</code>, et un fichier <a href="data/README.html">README</a> spécifique
en détaille l'installation et l'utilisation.</p>
<h1 id="versioning"><a class="header" href="#versioning">Versioning</a></h1>
<p>Le versioning de l'application permet de revenir à des anciennes versions d'Ecobalyse. Pour que ce versioning puisse fonctionner, les anciennes versions (&lt;= 2.0.0) doivent être patchées rétroactivement. Le script <code>./bin/build-specific-app-version.sh</code> permet de générer une version spécifique de l'application et d'appliquer les patchs si nécessaire. Par exemple, pour générer la version <code>1.3.2</code> (le deuxième paramètre est le commit du répertoire data associé) :</p>
<pre><code class="language-shell">pipenv run ./bin/build-specific-app-version.sh v1.3.2 3531c73f23a1eb6f1fc6b9c256a5344742230fcf
</code></pre>
<p>Un fichier <code>v1.3.2-dist.tar.gz</code> sera disponible à la racine du projet et un répertoire <code>v1.3.2</code> aura été créé dans <code>versions/</code>.</p>
<p>Le script python permettant de patcher les fichiers est disponible ici : <code>./bin/patch_files_for_versions_compat.py</code>.</p>
<p>Toutes les versions disponibles dans les releases Github ont été patchées comme il se doit.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->

                            <a rel="next prefetch" href="gestion-des-tests.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

                    <a rel="next prefetch" href="gestion-des-tests.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
